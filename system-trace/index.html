<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Trace Telemetry</title>
</head>
<body>
    <h1>System Trace Telemetry Collection</h1>
    <p>Client-side device, browser & runtime telemetry collection system</p>

    <div>
        <h2>Controls</h2>
        <div style="margin-bottom: 10px;">
            <label>
                <input type="checkbox" id="viewToggle" checked>
                Show Table View (uncheck for JSON view)
            </label>
        </div>
        <button id="btnInit">Initialize</button>
        <button id="btnStart">Start Continuous</button>
        <button id="btnStop">Stop Continuous</button>
        <button id="btnExport">Export JSON</button>
        <button id="btnExportCSV">Export CSV (Excel)</button>
        <button id="btnClear">Clear Display</button>
    </div>

    <div>
        <h2>Status</h2>
        <div id="status">Not initialized</div>
    </div>

    <div id="jsonView">
        <div>
            <h2>Static Telemetry</h2>
            <pre id="staticTelemetry"></pre>
        </div>

        <div>
            <h2>Continuous Telemetry (Latest Sample)</h2>
            <pre id="continuousTelemetry"></pre>
        </div>

        <div>
            <h2>Continuous Statistics</h2>
            <pre id="continuousStats"></pre>
        </div>

        <div>
            <h2>Inferred Telemetry</h2>
            <pre id="inferredTelemetry"></pre>
        </div>

        <div>
            <h2>All Telemetry (JSON)</h2>
            <pre id="allTelemetry"></pre>
        </div>

        <div>
            <h2>Product & Engagement</h2>
            <pre id="productTelemetry"></pre>
        </div>

        <div>
            <h2>Performance (Core Web Vitals)</h2>
            <pre id="performanceTelemetry"></pre>
        </div>

        <div>
            <h2>Network Resource Timings</h2>
            <pre id="networkTelemetry"></pre>
        </div>

        <div>
            <h2>Reliability & Errors</h2>
            <pre id="reliabilityTelemetry"></pre>
        </div>
    </div>

    <div id="tableView" style="display: none;">
        <h2>Excel-Like Data Table (Live Updates)</h2>
        <div style="overflow-x: auto; max-height: 600px; overflow-y: auto; border: 1px solid #ccc;">
            <table id="excelTable" style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; font-size: 12px;">
                <thead id="tableHeader" style="position: sticky; top: 0; background-color: #f0f0f0; z-index: 10;">
                    <!-- Headers will be populated dynamically -->
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be added dynamically -->
                </tbody>
            </table>
        </div>
        <div style="margin-top: 10px;">
            <button id="btnClearTable">Clear Table</button>
            <span id="tableRowCount" style="margin-left: 10px;">Rows: 0</span>
        </div>
    </div>

    <script src="metadata.js"></script>
    <script src="static-telemetry.js"></script>
    <script src="continuous-telemetry.js"></script>
    <script src="permission-telemetry.js"></script>
    <script src="product-telemetry.js"></script>
    <script src="performance-telemetry.js"></script>
    <script src="network-telemetry.js"></script>
    <script src="reliability-telemetry.js"></script>
    <script src="media-telemetry.js"></script>
    <script src="environment-telemetry.js"></script>
    <script src="inferred-telemetry.js"></script>
    <script src="schema-exporter.js"></script>
    <script src="telemetry.js"></script>
    <script>
        // Initialize telemetry collector
        const telemetry = new TelemetryCollector({
            continuousInterval: 5000,
            autoStart: false
        });

        // UI Elements
        const btnInit = document.getElementById('btnInit');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnExport = document.getElementById('btnExport');
        const btnExportCSV = document.getElementById('btnExportCSV');
        const btnClear = document.getElementById('btnClear');
        const statusDiv = document.getElementById('status');
        const staticDiv = document.getElementById('staticTelemetry');
        const continuousDiv = document.getElementById('continuousTelemetry');
        const continuousStatsDiv = document.getElementById('continuousStats');
        const inferredDiv = document.getElementById('inferredTelemetry');
        const allDiv = document.getElementById('allTelemetry');
        const productDiv = document.getElementById('productTelemetry');
        const performanceDiv = document.getElementById('performanceTelemetry');
        const networkDiv = document.getElementById('networkTelemetry');
        const reliabilityDiv = document.getElementById('reliabilityTelemetry');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const tableRowCount = document.getElementById('tableRowCount');
        const btnClearTable = document.getElementById('btnClearTable');
        const viewToggle = document.getElementById('viewToggle');
        const jsonView = document.getElementById('jsonView');
        const tableView = document.getElementById('tableView');

        // Toggle view
        viewToggle.addEventListener('change', () => {
            if (viewToggle.checked) {
                jsonView.style.display = 'none';
                tableView.style.display = 'block';
            } else {
                jsonView.style.display = 'block';
                tableView.style.display = 'none';
            }
        });

        // Update status
        function updateStatus(message) {
            statusDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        }

        // Update displays
        function updateDisplays() {
            try {
                const allData = telemetry.getAllTelemetry();

                // Static
                staticDiv.textContent = JSON.stringify(allData.static, null, 2);

                // Continuous latest
                if (allData.continuous.latest) {
                    continuousDiv.textContent = JSON.stringify(allData.continuous.latest, null, 2);
                } else {
                    continuousDiv.textContent = 'No samples yet';
                }

                // Continuous statistics
                if (allData.continuous.statistics) {
                    continuousStatsDiv.textContent = JSON.stringify(allData.continuous.statistics, null, 2);
                } else {
                    continuousStatsDiv.textContent = 'No statistics available';
                }

                // Inferred
                if (allData.inferred) {
                    inferredDiv.textContent = JSON.stringify(allData.inferred, null, 2);
                } else {
                    inferredDiv.textContent = 'No inferred data yet';
                }

                // All data
                allDiv.textContent = telemetry.exportJSON();

                // Extended telemetry
                try {
                    const extended = telemetry.getAllTelemetryExtended();
                    productDiv.textContent = JSON.stringify(extended.product, null, 2);
                    performanceDiv.textContent = JSON.stringify(extended.performance, null, 2);
                    networkDiv.textContent = JSON.stringify(extended.network, null, 2);
                    reliabilityDiv.textContent = JSON.stringify(extended.reliability.summary, null, 2);
                } catch (e) {
                    // Extended data not available yet
                }
            } catch (error) {
                updateStatus(`Error updating displays: ${error.message}`);
            }
        }

        // Event handlers
        btnInit.addEventListener('click', async () => {
            try {
                updateStatus('Initializing...');
                await telemetry.initialize();
                updateStatus('Initialized');
                updateDisplays();
                initializeTable(); // Initialize table after telemetry is ready
            } catch (error) {
                updateStatus(`Initialization error: ${error.message}`);
            }
        });

        btnStart.addEventListener('click', () => {
            try {
                telemetry.start();
                updateStatus('Continuous collection started');
                updateDisplays();
            } catch (error) {
                updateStatus(`Start error: ${error.message}`);
            }
        });

        btnStop.addEventListener('click', () => {
            try {
                telemetry.stop();
                updateStatus('Continuous collection stopped');
                updateDisplays();
            } catch (error) {
                updateStatus(`Stop error: ${error.message}`);
            }
        });

        btnExport.addEventListener('click', () => {
            try {
                const json = telemetry.exportJSON();
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `telemetry-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                updateStatus('Exported JSON to file');
            } catch (error) {
                updateStatus(`Export error: ${error.message}`);
            }
        });

        btnExportCSV.addEventListener('click', () => {
            try {
                const csv = telemetry.exportToCSV();
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `telemetry-${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                updateStatus('Exported CSV to file (Excel-ready)');
            } catch (error) {
                updateStatus(`CSV Export error: ${error.message}`);
            }
        });

        btnClear.addEventListener('click', () => {
            staticDiv.textContent = '';
            continuousDiv.textContent = '';
            continuousStatsDiv.textContent = '';
            inferredDiv.textContent = '';
            allDiv.textContent = '';
            updateStatus('Display cleared');
        });

        // Set up callbacks
        telemetry.onSample((sample) => {
            updateDisplays();
        });

        telemetry.onInferred((inferred) => {
            updateDisplays();
        });

        telemetry.onError((error) => {
            updateStatus(`Error: ${error.message}`);
            console.error('Telemetry error:', error);
        });

        // Auto-update display every second
        setInterval(() => {
            try {
                if (telemetry.staticData) {
                    updateDisplays();
                    updateTable(); // Update Excel-like table
                }
            } catch (e) {
                // Not initialized yet
            }
        }, 1000);

        // Initialize Excel-like table
        let tableHeaders = [];
        let staticRowAdded = false;

        function initializeTable() {
            // Get column headers from schema exporter
            tableHeaders = telemetry.getColumnHeaders();

            // Create header row
            const headerRow = document.createElement('tr');
            tableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.style.border = '1px solid #ccc';
                th.style.padding = '4px 8px';
                th.style.textAlign = 'left';
                th.style.backgroundColor = '#e0e0e0';
                th.style.fontWeight = 'bold';
                headerRow.appendChild(th);
            });
            tableHeader.innerHTML = '';
            tableHeader.appendChild(headerRow);
        }

        function addTableRow(data, rowType = 'CONTINUOUS') {
            const row = document.createElement('tr');
            row.style.backgroundColor = rowType === 'STATIC' ? '#fff9e6' : '#ffffff';

            tableHeaders.forEach(header => {
                const td = document.createElement('td');
                const value = data[header];

                // Format the value
                if (value === null || value === undefined) {
                    td.textContent = '';
                    td.style.color = '#999';
                } else if (typeof value === 'boolean') {
                    td.textContent = value ? 'true' : 'false';
                    td.style.color = value ? '#006400' : '#8b0000';
                } else if (typeof value === 'number') {
                    td.textContent = value;
                    td.style.textAlign = 'right';
                } else {
                    td.textContent = String(value);
                }

                td.style.border = '1px solid #ccc';
                td.style.padding = '4px 8px';
                td.style.fontSize = '11px';
                row.appendChild(td);
            });

            tableBody.appendChild(row);

            // Update row count
            const rowCount = tableBody.children.length;
            tableRowCount.textContent = `Rows: ${rowCount}`;

            // Scroll to bottom
            const tableContainer = tableBody.parentElement.parentElement;
            tableContainer.scrollTop = tableContainer.scrollHeight;
        }

        function updateTable() {
            try {
                // Add static row once
                if (!staticRowAdded && telemetry.staticData) {
                    const staticRow = telemetry.exportStaticRow();
                    if (staticRow) {
                        addTableRow(staticRow, 'STATIC');
                        staticRowAdded = true;
                    }
                }

                // Add continuous rows
                const continuousRows = telemetry.exportContinuousRows();
                const currentRowCount = tableBody.children.length - (staticRowAdded ? 1 : 0);

                if (continuousRows.length > currentRowCount) {
                    // Add new rows
                    for (let i = currentRowCount; i < continuousRows.length; i++) {
                        addTableRow(continuousRows[i], 'CONTINUOUS');
                    }
                }
            } catch (error) {
                // Table not ready yet
            }
        }

        btnClearTable.addEventListener('click', () => {
            tableBody.innerHTML = '';
            staticRowAdded = false;
            tableRowCount.textContent = 'Rows: 0';
        });

        // Auto-initialize on load
        window.addEventListener('load', () => {
            btnInit.click();

            // Initialize table after a short delay
            setTimeout(() => {
                initializeTable();
            }, 500);

            // Track first meaningful action
            setTimeout(() => {
                telemetry.performanceTelemetry.trackFirstMeaningfulAction('page_load');
            }, 1000);
        });

        // Example: Track feature usage
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                telemetry.trackFeature('button_click', { button_id: e.target.id });
            }
        });
    </script>
</body>
</html>
